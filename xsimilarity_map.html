{% extends "base.html" %}

{% block title %}Document Similarity Map{% endblock %}

{% block extra_css %}
<style>
  .document-card {
    height: 100%;
    transition: all 0.3s ease;
  }
  
  .document-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
  }
  
  .document-card .card-header {
    display: flex;
    align-items: center;
  }
  
  .document-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
    margin-right: 0.75rem;
    flex-shrink: 0;
  }
  
  .document-icon.pdf {
    background-color: rgba(255, 82, 82, 0.15);
    color: var(--danger);
  }
  
  .document-icon.docx {
    background-color: rgba(98, 0, 238, 0.15);
    color: var(--primary);
  }
  
  .document-title {
    font-weight: 600;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .similarity-table th {
    white-space: nowrap;
    position: sticky;
    top: 0;
    background-color: var(--primary);
    color: white;
    z-index: 1;
  }
  
  .similarity-row:hover {
    background-color: var(--gray-100);
  }
  
  .similarity-score {
    width: 60px;
    height: 30px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    color: white;
  }
  
  .network-visualization {
    position: relative;
    width: 100%;
    height: 650px;
    overflow: hidden;
    background-color: var(--gray-50);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
  }
  
  .network-controls {
    position: absolute;
    top: 1rem;
    right: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    z-index: 10;
  }
  
  .network-control-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: white;
    color: var(--gray-700);
    border: none;
    box-shadow: var(--shadow-md);
    transition: all 0.2s;
  }
  
  .network-control-btn:hover {
    transform: scale(1.1);
    background-color: var(--primary);
    color: white;
  }
  
  .network-zoom-controls {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    display: flex;
    flex-direction: column;
    background-color: white;
    border-radius: var(--radius-md);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    z-index: 10;
  }
  
  .zoom-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: var(--gray-700);
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .zoom-btn:hover {
    background-color: var(--gray-100);
    color: var(--primary);
  }
  
  .zoom-slider {
    height: 100px;
    width: 36px;
    padding: 0.5rem 0;
    background-color: var(--gray-100);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .zoom-slider input {
    width: 100px;
    transform: rotate(-90deg);
  }
  
  .network-legend {
    position: absolute;
    bottom: 1rem;
    left: 1rem;
    background-color: white;
    border-radius: var(--radius-md);
    padding: 0.75rem;
    box-shadow: var(--shadow-md);
    z-index: 10;
  }
  
  .legend-title {
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    font-size: 0.75rem;
    margin-bottom: 0.25rem;
  }
  
  .legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    margin-right: 0.5rem;
  }
  
  .network-tooltip {
    position: absolute;
    padding: 0.75rem;
    background-color: white;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    max-width: 300px;
    z-index: 100;
  }
  
  .network-tooltip.visible {
    opacity: 1;
  }
  
  .node-details {
    padding: 1rem;
    background-color: var(--gray-50);
    border-radius: var(--radius-md);
    border-left: 3px solid var(--primary);
  }
  
  .node-details-header {
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
  }
  
  .node-details-title {
    font-weight: 600;
    font-size: 1.125rem;
    margin-bottom: 0.25rem;
    word-break: break-word;
  }
  
  .node-details-subtitle {
    color: var(--gray-600);
    font-size: 0.875rem;
  }
  
  .node-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.75rem;
    margin: 1rem 0;
  }
  
  .node-stat {
    padding: 0.75rem;
    background-color: white;
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-sm);
  }
  
  .node-stat-value {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  
  .node-stat-label {
    font-size: 0.75rem;
    color: var(--gray-600);
  }
  
  .node-connections {
    margin-top: 0.75rem;
  }
  
  .node-connection {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-radius: var(--radius-sm);
    margin-bottom: 0.5rem;
    background-color: white;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s;
  }
  
  .node-connection:hover {
    transform: translateX(3px);
    background-color: var(--gray-100);
  }
  
  .connection-strength {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    font-weight: 500;
    flex-shrink: 0;
  }
  
  .connection-info {
    font-size: 0.875rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  /* Settings panel */
  .settings-panel {
    position: absolute;
    top: 1rem;
    left: 1rem;
    background-color: white;
    border-radius: var(--radius-md);
    padding: 1rem;
    box-shadow: var(--shadow-lg);
    width: 300px;
    z-index: 10;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }
  
  .settings-panel.hidden {
    transform: translateX(-320px);
    opacity: 0;
    pointer-events: none;
  }
  
  .settings-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }
  
  .settings-title {
    font-weight: 600;
    margin: 0;
  }
  
  .settings-close {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--gray-600);
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
  }
  
  .settings-close:hover {
    background-color: var(--gray-100);
    color: var(--gray-900);
  }
  
  .settings-section {
    margin-bottom: 1rem;
  }
  
  .settings-section-title {
    font-weight: 500;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
    color: var(--gray-700);
  }
  
  /* Loading indicator */
  .network-loading {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 20;
  }
  
  .network-loading.hidden {
    display: none;
  }
  
  .loader {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    position: relative;
    animation: rotate 1s linear infinite;
  }
  
  .loader::before,
  .loader::after {
    content: "";
    box-sizing: border-box;
    position: absolute;
    inset: 0px;
    border-radius: 50%;
    border: 5px solid var(--primary);
    animation: prixClipFix 2s linear infinite;
  }
  
  .loader::after {
    inset: 8px;
    transform: rotate3d(90, 90, 0, 180deg);
    border-color: var(--secondary);
  }
  
  @keyframes rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  @keyframes prixClipFix {
    0% { clip-path: polygon(50% 50%, 0 0, 0 0, 0 0, 0 0, 0 0); }
    50% { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 0, 100% 0, 100% 0); }
    75% { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 100%, 100% 100%, 100% 100%); }
    100% { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 100%, 0 100%, 0 100%); }
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="mb-0">Document Similarity Map</h1>
    <p class="text-muted mt-1 mb-0">Visualize relationships between documents based on shared content</p>
  </div>
  <div>
    <a href="{{ url_for('documents') }}" class="btn btn-outline-secondary me-2">
      <i class="bi bi-file-earmark-text"></i> View Documents
    </a>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#calculateSimilaritiesModal">
      <i class="bi bi-arrow-repeat"></i> Calculate Similarities
    </button>
  </div>
</div>

{% if not similarity_count %}
<div class="alert alert-info">
  <div class="d-flex">
    <div class="me-3">
      <i class="bi bi-info-circle-fill fs-4"></i>
    </div>
    <div>
      <h5>No Document Similarities Calculated</h5>
      <p class="mb-0">Document similarities have not been calculated yet. Click "Calculate Similarities" to analyze document relationships.</p>
      {% if documents|length < 2 %}
      <p class="mt-2 mb-0"><strong>Note:</strong> You need at least 2 processed documents to calculate similarities.</p>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

<div class="row">
  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Document Similarity Network</h5>
      </div>
      <div class="card-body p-0">
        <div class="network-visualization" id="similarityNetwork">
          <!-- Loading indicator -->
          <div class="network-loading {% if not similarity_count %}hidden{% endif %}" id="networkLoading">
            <div class="loader"></div>
          </div>
          
          <!-- Viz container -->
          <svg width="100%" height="100%" id="networkSvg"></svg>
          
          <!-- Network controls -->
          <div class="network-controls">
            <button class="network-control-btn" id="settingsToggleBtn" title="Visualization settings">
              <i class="bi bi-sliders"></i>
            </button>
            <button class="network-control-btn" id="clusterBtn" title="Group by similarity">
              <i class="bi bi-diagram-3"></i>
            </button>
            <button class="network-control-btn" id="resetLayoutBtn" title="Reset layout">
              <i class="bi bi-arrow-counterclockwise"></i>
            </button>
          </div>
          
          <!-- Zoom controls -->
          <div class="network-zoom-controls">
            <button class="zoom-btn" id="zoomInBtn" title="Zoom in">
              <i class="bi bi-plus"></i>
            </button>
            <div class="zoom-slider">
              <input type="range" id="zoomSlider" min="0.5" max="2" step="0.1" value="1" orient="vertical">
            </div>
            <button class="zoom-btn" id="zoomOutBtn" title="Zoom out">
              <i class="bi bi-dash"></i>
            </button>
            <button class="zoom-btn" id="zoomResetBtn" title="Reset zoom">
              <i class="bi bi-arrows-angle-contract"></i>
            </button>
          </div>
          
          <!-- Legend -->
          <div class="network-legend">
            <div class="legend-title">Legend</div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: var(--danger);"></div>
              <span>PDF Document</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: var(--primary);"></div>
              <span>DOCX Document</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: var(--gray-400); width: 20px; height: 2px;"></div>
              <span>Low Similarity</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: var(--primary); width: 20px; height: 4px;"></div>
              <span>High Similarity</span>
            </div>
          </div>
          
          <!-- Node tooltip -->
          <div class="network-tooltip" id="nodeTooltip"></div>
          
          <!-- Settings panel -->
          <div class="settings-panel hidden" id="settingsPanel">
            <div class="settings-header">
              <h6 class="settings-title">Visualization Settings</h6>
              <button class="settings-close" id="settingsCloseBtn">
                <i class="bi bi-x"></i>
              </button>
            </div>
            
            <div class="settings-section">
              <div class="settings-section-title">Minimum Similarity</div>
              <div class="d-flex align-items-center">
                <input type="range" class="form-range" id="minSimilaritySlider" min="0.1" max="0.9" step="0.05" value="0.3">
                <span class="ms-2 badge bg-primary" id="minSimilarityValue">0.3</span>
              </div>
            </div>
            
            <div class="settings-section">
              <div class="settings-section-title">Link Strength</div>
              <div class="d-flex align-items-center">
                <input type="range" class="form-range" id="linkStrengthSlider" min="0.1" max="1" step="0.1" value="0.5">
                <span class="ms-2 badge bg-primary" id="linkStrengthValue">0.5</span>
              </div>
            </div>
            
            <div class="settings-section">
              <div class="settings-section-title">Node Size</div>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="nodeSizeOption" id="nodeSizeParagraphs" autocomplete="off" checked>
                <label class="btn btn-outline-primary" for="nodeSizeParagraphs">By Paragraphs</label>
                
                <input type="radio" class="btn-check" name="nodeSizeOption" id="nodeSizeUniform" autocomplete="off">
                <label class="btn btn-outline-primary" for="nodeSizeUniform">Uniform</label>
              </div>
            </div>
            
            <div class="settings-section">
              <div class="settings-section-title">Visualization Style</div>
              <select class="form-select" id="layoutSelect">
                <option value="force" selected>Force-Directed</option>
                <option value="radial">Radial</option>
                <option value="cluster">Cluster</option>
              </select>
            </div>
            
            <div class="mt-3">
              <button class="btn btn-primary w-100" id="applySettingsBtn">
                <i class="bi bi-check-circle me-1"></i> Apply Settings
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="card-footer">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <span class="text-muted">{{ documents|length }} documents, {{ similarity_count }} connections</span>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-primary" id="exportNetworkBtn">
              <i class="bi bi-download me-1"></i> Export As SVG
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Selected Document Details -->
    <div class="card mb-4" id="selectedDocumentCard" style="display: none;">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0" id="selectedDocumentTitle">Document Details</h5>
        <button type="button" class="btn btn-sm btn-close" id="closeDetailsBtn"></button>
      </div>
      <div class="card-body">
        <div class="node-details">
          <div class="node-details-header">
            <div class="document-icon" id="selectedDocIcon">
              <i class="bi bi-file-earmark-text"></i>
            </div>
            <div>
              <div class="node-details-title" id="selectedDocName">Document Name</div>
              <div class="node-details-subtitle" id="selectedDocType">File Type</div>
            </div>
          </div>
          
          <div class="node-stats">
            <div class="node-stat">
              <div class="node-stat-value" id="selectedDocPages">0</div>
              <div class="node-stat-label">Pages</div>
            </div>
            <div class="node-stat">
              <div class="node-stat-value" id="selectedDocParagraphs">0</div>
              <div class="node-stat-label">Paragraphs</div>
            </div>
            <div class="node-stat">
              <div class="node-stat-value" id="selectedDocConnections">0</div>
              <div class="node-stat-label">Connections</div>
            </div>
          </div>
          
          <div class="d-flex justify-content-between mb-3">
            <a href="#" id="viewDocLink" class="btn btn-primary btn-sm">
              <i class="bi bi-eye me-1"></i> View Document
            </a>
            <button type="button" id="highlightConnectionsBtn" class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-lightbulb me-1"></i> Highlight Connections
            </button>
          </div>
          
          <div id="nodeConnectionsList" class="node-connections">
            <!-- Connection items will be added here -->
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <!-- Top Document Similarities Card -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Strongest Similarities</h5>
        {% if similarities %}
        <span class="badge bg-primary">{{ similarities|length }}</span>
        {% endif %}
      </div>
      <div class="card-body p-0">
        {% if similarities %}
        <div class="table-responsive" style="max-height: 400px;">
          <table class="table similarity-table mb-0">
            <thead class="bg-primary text-white">
              <tr>
                <th>Documents</th>
                <th>Similarity</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for sim in similarities[:10] %}
              <tr class="similarity-row">
                <td>
                  <div class="d-flex flex-column">
                    <span class="text-truncate" style="max-width: 180px;">{{ sim.source.original_filename }}</span>
                    <i class="bi bi-arrow-down-short text-muted mx-auto my-1"></i>
                    <span class="text-truncate" style="max-width: 180px;">{{ sim.target.original_filename }}</span>
                  </div>
                </td>
                <td>
                  {% set score = sim.similarity_score * 100 %}
                  {% set bg_class = 'bg-success' if score >= 70 else 'bg-warning' if score >= 40 else 'bg-info' %}
                  <div class="similarity-score {{ bg_class }}">
                    {{ score|round(1) }}%
                  </div>
                </td>
                <td>
                  <a href="{{ url_for('compare_documents', doc1=sim.source_id, doc2=sim.target_id) }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i>
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        {% if similarities|length > 10 %}
        <div class="text-center py-2 border-top">
          <button type="button" class="btn btn-sm btn-link" data-bs-toggle="modal" data-bs-target="#allSimilaritiesModal">
            View all {{ similarities|length }} similarities
          </button>
        </div>
        {% endif %}
        
        {% else %}
        <div class="p-4 text-center">
          <i class="bi bi-diagram-3 text-muted fs-1"></i>
          <p class="mt-3 text-muted">No similarities calculated yet</p>
          <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#calculateSimilaritiesModal">
            Calculate Similarities
          </button>
        </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Document List Card -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">All Documents</h5>
        <span class="badge bg-primary">{{ documents|length }}</span>
      </div>
      <div class="card-body p-0">
        {% if documents %}
        <div class="list-group list-group-flush">
          {% for doc in documents %}
          <div class="list-group-item p-3">
            <div class="d-flex align-items-center">
              <div class="document-icon {{ doc.file_type }}">
                <i class="bi bi-file-earmark-{{ 'pdf' if doc.file_type == 'pdf' else 'word' }}"></i>
              </div>
              <div class="flex-grow-1 min-width-0">
                <h6 class="mb-0 text-truncate">{{ doc.original_filename }}</h6>
                <p class="mb-0 small text-muted">
                  {{ doc.file_type.upper() }} â€¢ {{ doc.paragraph_count }} paragraphs
                </p>
              </div>
              <div class="ms-2 d-flex">
                <a href="{{ url_for('view_document', id=doc.id) }}" class="btn btn-sm btn-outline-primary" title="View document">
                  <i class="bi bi-eye"></i>
                </a>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-1 focus-document-btn" 
                        data-doc-id="{{ doc.id }}"
                        title="Focus in visualization">
                  <i class="bi bi-bullseye"></i>
                </button>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="p-4 text-center">
          <i class="bi bi-file-earmark-x text-muted fs-1"></i>
          <p class="mt-3 text-muted">No documents found</p>
          <a href="{{ url_for('upload') }}" class="btn btn-primary btn-sm">
            Upload Documents
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Calculate Similarities Modal -->
<div class="modal fade" id="calculateSimilaritiesModal" tabindex="-1" aria-labelledby="calculateSimilaritiesModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="calculateSimilaritiesModalLabel">Calculate Document Similarities</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('calculate_similarities') }}" id="calculateSimilaritiesForm">
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            This process will analyze all documents and identify relationships based on shared content.
          </div>
          
          <div class="mb-3">
            <label for="minSimilarity" class="form-label">Minimum Similarity Threshold</label>
            <div class="d-flex align-items-center">
              <input type="range" class="form-range flex-grow-1" id="minSimilarity" name="min_similarity" 
                    min="0.1" max="0.9" step="0.05" value="0.3">
              <span class="ms-2 badge bg-primary" id="minSimilarityDisplay">0.3</span>
            </div>
            <div class="form-text">
              Higher values show only strong relationships. Lower values include more tenuous connections.
            </div>
          </div>
          
          <div class="progress mb-3 d-none" id="calculationProgress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="calculateBtn">
            <i class="bi bi-arrow-repeat me-1"></i> Calculate Similarities
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- All Similarities Modal -->
<div class="modal fade" id="allSimilaritiesModal" tabindex="-1" aria-labelledby="allSimilaritiesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="allSimilaritiesModalLabel">All Document Similarities</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div class="table-responsive" style="max-height: 500px;">
          <table class="table table-striped table-hover mb-0">
            <thead class="bg-primary text-white">
              <tr>
                <th>Document 1</th>
                <th>Document 2</th>
                <th>Similarity Score</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for sim in similarities %}
              <tr>
                <td class="text-truncate" style="max-width: 200px;">
                  <a href="{{ url_for('view_document', id=sim.source_id) }}">
                    {{ sim.source.original_filename }}
                  </a>
                </td>
                <td class="text-truncate" style="max-width: 200px;">
                  <a href="{{ url_for('view_document', id=sim.target_id) }}">
                    {{ sim.target.original_filename }}
                  </a>
                </td>
                <td>
                  {% set score = sim.similarity_score * 100 %}
                  {% set bg_class = 'bg-success' if score >= 70 else 'bg-warning' if score >= 40 else 'bg-info' %}
                  <div class="similarity-score {{ bg_class }}">
                    {{ score|round(1) }}%
                  </div>
                </td>
                <td>
                  <a href="{{ url_for('compare_documents', doc1=sim.source_id, doc2=sim.target_id) }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye me-1"></i> Compare
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Threshold slider interaction
    const minSimilarity = document.getElementById('minSimilarity');
    const minSimilarityDisplay = document.getElementById('minSimilarityDisplay');
    
    if (minSimilarity && minSimilarityDisplay) {
      minSimilarity.addEventListener('input', function() {
        minSimilarityDisplay.textContent = this.value;
      });
    }
    
    // Form submission handling
    const calculateForm = document.getElementById('calculateSimilaritiesForm');
    const calculateBtn = document.getElementById('calculateBtn');
    const calculationProgress = document.getElementById('calculationProgress');
    
    if (calculateForm) {
      calculateForm.addEventListener('submit', function(e) {
        // Show loading state
        if (calculateBtn) {
          calculateBtn.disabled = true;
          calculateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Calculating...';
        }
        
        // Show fake progress
        if (calculationProgress) {
          calculationProgress.classList.remove('d-none');
          const progressBar = calculationProgress.querySelector('.progress-bar');
          
          let progress = 0;
          const interval = setInterval(function() {
            progress += 5;
            if (progress > 95) clearInterval(interval);
            progressBar.style.width = progress + '%';
          }, 200);
        }
      });
    }
    
    // Settings panel interaction
    const settingsToggleBtn = document.getElementById('settingsToggleBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const settingsCloseBtn = document.getElementById('settingsCloseBtn');
    
    if (settingsToggleBtn && settingsPanel) {
      settingsToggleBtn.addEventListener('click', function() {
        settingsPanel.classList.toggle('hidden');
      });
    }
    
    if (settingsCloseBtn && settingsPanel) {
      settingsCloseBtn.addEventListener('click', function() {
        settingsPanel.classList.add('hidden');
      });
    }
    
    // Settings sliders
    const minSimilaritySlider = document.getElementById('minSimilaritySlider');
    const minSimilarityValue = document.getElementById('minSimilarityValue');
    const linkStrengthSlider = document.getElementById('linkStrengthSlider');
    const linkStrengthValue = document.getElementById('linkStrengthValue');
    
    if (minSimilaritySlider && minSimilarityValue) {
      minSimilaritySlider.addEventListener('input', function() {
        minSimilarityValue.textContent = this.value;
      });
    }
    
    if (linkStrengthSlider && linkStrengthValue) {
      linkStrengthSlider.addEventListener('input', function() {
        linkStrengthValue.textContent = this.value;
      });
    }
    
    // Initialize visualization if we have data
    const visualizationData = {{ visualization_data|tojson if visualization_data else '{}' }};
    
    if (Object.keys(visualizationData).length > 0) {
      initializeNetworkVisualization(visualizationData);
    } else {
      // No data, hide loading
      document.getElementById('networkLoading').classList.add('hidden');
      
      // Show placeholder
      const svg = d3.select('#networkSvg');
      const width = svg.node().clientWidth;
      const height = svg.node().clientHeight;
      
      svg.append('text')
        .attr('x', width / 2)
        .attr('y', height / 2)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .attr('font-size', '16px')
        .attr('fill', '#6c757d')
        .text('No similarity data available');
        
      svg.append('text')
        .attr('x', width / 2)
        .attr('y', height / 2 + 30)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .attr('font-size', '14px')
        .attr('fill', '#6c757d')
        .text('Click "Calculate Similarities" to analyze document relationships');
    }
    
    function initializeNetworkVisualization(data) {
      // Get DOM elements
      const svg = d3.select('#networkSvg');
      const tooltip = d3.select('#nodeTooltip');
      const zoomSlider = document.getElementById('zoomSlider');
      const zoomInBtn = document.getElementById('zoomInBtn');
      const zoomOutBtn = document.getElementById('zoomOutBtn');
      const zoomResetBtn = document.getElementById('zoomResetBtn');
      const resetLayoutBtn = document.getElementById('resetLayoutBtn');
      const clusterBtn = document.getElementById('clusterBtn');
      const exportNetworkBtn = document.getElementById('exportNetworkBtn');
      
      // Document details elements
      const selectedDocumentCard = document.getElementById('selectedDocumentCard');
      const selectedDocName = document.getElementById('selectedDocName');
      const selectedDocType = document.getElementById('selectedDocType');
      const selectedDocIcon = document.getElementById('selectedDocIcon');
      const selectedDocPages = document.getElementById('selectedDocPages');
      const selectedDocParagraphs = document.getElementById('selectedDocParagraphs');
      const selectedDocConnections = document.getElementById('selectedDocConnections');
      const viewDocLink = document.getElementById('viewDocLink');
      const nodeConnectionsList = document.getElementById('nodeConnectionsList');
      const closeDetailsBtn = document.getElementById('closeDetailsBtn');
      const highlightConnectionsBtn = document.getElementById('highlightConnectionsBtn');
      
      // Initialize variables
      const width = svg.node().clientWidth;
      const height = svg.node().clientHeight;
      let currentTransform = d3.zoomIdentity;
      let selectedNode = null;
      
      // Define node colors based on file type
      const nodeColor = d => d.file_type === 'pdf' ? '#FF5252' : '#6200EE';
      
      // Get container size
      const g = svg.append('g');
      
      // Configure zoom behavior
      const zoom = d3.zoom()
        .scaleExtent([0.2, 3])
        .on('zoom', event => {
          currentTransform = event.transform;
          g.attr('transform', currentTransform);
        });
      
      svg.call(zoom);
      
      // Initialize force simulation
      const simulation = d3.forceSimulation(data.nodes)
        .force('link', d3.forceLink(data.links).id(d => d.id).distance(d => 200 * (1 - Math.pow(d.similarity, 2))))
        .force('charge', d3.forceManyBody().strength(-600))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('x', d3.forceX(width / 2).strength(0.1))
        .force('y', d3.forceY(height / 2).strength(0.1))
        .on('tick', ticked);
      
      // Create links
      const links = g.append('g')
        .attr('class', 'links')
        .selectAll('line')
        .data(data.links)
        .enter().append('line')
        .attr('stroke', '#9CA3AF')
        .attr('stroke-opacity', 0.6)
        .attr('stroke-width', d => 1 + d.similarity * 4);
      
      // Create nodes
      const nodes = g.append('g')
        .attr('class', 'nodes')
        .selectAll('g')
        .data(data.nodes)
        .enter().append('g')
        .attr('class', 'node')
        .call(d3.drag()
          .on('start', dragstarted)
          .on('drag', dragged)
          .on('end', dragended))
        .on('click', (event, d) => {
          event.stopPropagation();
          selectNode(d);
        })
        .on('mouseover', (event, d) => {
          showTooltip(event, d);
        })
        .on('mouseout', () => {
          hideTooltip();
        });
      
      // Add node circles
      nodes.append('circle')
        .attr('r', d => 8 + Math.sqrt(d.paragraphs || 5) * 1.2)
        .attr('fill', d => nodeColor(d))
        .attr('stroke', '#FFFFFF')
        .attr('stroke-width', 2);
      
      // Add node labels
      nodes.append('text')
        .text(d => d.name.length > 25 ? d.name.substring(0, 22) + '...' : d.name)
        .attr('x', d => 8 + Math.sqrt(d.paragraphs || 5) * 1.2 + 4)
        .attr('y', 4)
        .attr('font-size', '12px')
        .attr('fill', '#374151')
        .attr('font-weight', '500');
      
      // Clear loading indicator
      document.getElementById('networkLoading').classList.add('hidden');
      
      // Initialize focus document buttons
      document.querySelectorAll('.focus-document-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const docId = parseInt(this.getAttribute('data-doc-id'));
          const node = data.nodes.find(n => n.id === docId);
          if (node) {
            focusNode(node);
          }
        });
      });
      
      // Zoom control event listeners
      if (zoomSlider) {
        zoomSlider.addEventListener('input', function() {
          const scale = parseFloat(this.value);
          svg.call(zoom.transform, d3.zoomIdentity.translate(width/2, height/2).scale(scale).translate(-width/2, -height/2));
        });
      }
      
      if (zoomInBtn) {
        zoomInBtn.addEventListener('click', function() {
          svg.transition().duration(300).call(zoom.scaleBy, 1.2);
          updateZoomSlider();
        });
      }
      
      if (zoomOutBtn) {
        zoomOutBtn.addEventListener('click', function() {
          svg.transition().duration(300).call(zoom.scaleBy, 0.8);
          updateZoomSlider();
        });
      }
      
      if (zoomResetBtn) {
        zoomResetBtn.addEventListener('click', function() {
          svg.transition().duration(300).call(zoom.transform, d3.zoomIdentity);
          updateZoomSlider();
        });
      }
      
      if (resetLayoutBtn) {
        resetLayoutBtn.addEventListener('click', function() {
          // Reset simulation forces
          simulation.force('link').distance(d => 200 * (1 - Math.pow(d.similarity, 2)));
          simulation.force('charge').strength(-600);
          
          // Reset node positions
          data.nodes.forEach(node => {
            node.x = width / 2 + (Math.random() - 0.5) * 100;
            node.y = height / 2 + (Math.random() - 0.5) * 100;
            node.fx = null;
            node.fy = null;
          });
          
          // Reset zoom
          svg.transition().duration(300).call(zoom.transform, d3.zoomIdentity);
          updateZoomSlider();
          
          // Reset selection
          clearSelection();
          
          // Restart simulation
          simulation.alpha(1).restart();
        });
      }
      
      if (closeDetailsBtn) {
        closeDetailsBtn.addEventListener('click', function() {
          clearSelection();
        });
      }
      
      if (highlightConnectionsBtn && selectedNode) {
        highlightConnectionsBtn.addEventListener('click', function() {
          toggleHighlightConnections();
        });
      }
      
      if (clusterBtn) {
        clusterBtn.addEventListener('click', function() {
          applyClusterLayout();
        });
      }
      
      // Export button
      if (exportNetworkBtn) {
        exportNetworkBtn.addEventListener('click', function() {
          exportSvg();
        });
      }
      
      // Update network on settings change
      const applySettingsBtn = document.getElementById('applySettingsBtn');
      if (applySettingsBtn) {
        applySettingsBtn.addEventListener('click', function() {
          applyNetworkSettings();
        });
      }
      
      // Function to update node and link positions on tick
      function ticked() {
        links
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);
        
        nodes.attr('transform', d => `translate(${d.x},${d.y})`);
      }
      
      // Functions for node dragging
      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }
      
      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }
      
      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        // Don't release if we're dragging a selected node
        if (selectedNode !== d) {
          d.fx = null;
          d.fy = null;
        }
      }
      
      // Show tooltip
      function showTooltip(event, d) {
        const x = event.pageX;
        const y = event.pageY;
        
        // Get connected nodes
        const connectedLinks = data.links.filter(link => 
          link.source.id === d.id || link.target.id === d.id);
        
        // Format tooltip content
        tooltip.html(`
          <div class="p-2">
            <div class="fw-bold mb-1">${d.name}</div>
            <div class="small text-muted">${d.file_type.toUpperCase()}</div>
            <div class="d-flex justify-content-between mt-2">
              <div class="me-3">
                <div class="small text-muted">Paragraphs</div>
                <div class="fw-bold">${d.paragraphs}</div>
              </div>
              <div>
                <div class="small text-muted">Connections</div>
                <div class="fw-bold">${connectedLinks.length}</div>
              </div>
            </div>
          </div>
        `);
        
        tooltip
          .style('left', `${x + 10}px`)
          .style('top', `${y - 10}px`)
          .classed('visible', true);
      }
      
      // Hide tooltip
      function hideTooltip() {
        tooltip.classed('visible', false);
      }
      
      // Select a node
      function selectNode(d) {
        // Clear previous selection
        nodes.selectAll('circle').attr('stroke', '#FFFFFF').attr('stroke-width', 2);
        links.attr('stroke', '#9CA3AF').attr('stroke-opacity', 0.6);
        
        // Update selected node
        selectedNode = d;
        
        // Highlight selected node
        nodes.filter(n => n.id === d.id)
          .select('circle')
          .attr('stroke', '#FF9E0B')
          .attr('stroke-width', 3);
        
        // Find connected links and nodes
        const connectedLinks = data.links.filter(link => 
          link.source.id === d.id || link.target.id === d.id);
        
        const connectedNodeIds = new Set();
        connectedLinks.forEach(link => {
          if (link.source.id === d.id) connectedNodeIds.add(link.target.id);
          if (link.target.id === d.id) connectedNodeIds.add(link.source.id);
        });
        
        // Update details panel
        selectedDocName.textContent = d.name;
        selectedDocType.textContent = d.file_type.toUpperCase();
        selectedDocIcon.className = `document-icon ${d.file_type}`;
        selectedDocIcon.innerHTML = `<i class="bi bi-file-earmark-${d.file_type === 'pdf' ? 'pdf' : 'word'}"></i>`;
        selectedDocPages.textContent = d.size || '-';
        selectedDocParagraphs.textContent = d.paragraphs || '-';
        selectedDocConnections.textContent = connectedLinks.length;
        viewDocLink.href = `/document/${d.id}`;
        
        // Update connections list
        nodeConnectionsList.innerHTML = '';
        
        if (connectedLinks.length === 0) {
          nodeConnectionsList.innerHTML = '<div class="text-center text-muted p-3">No connections to other documents</div>';
        } else {
          // Sort by similarity strength
          connectedLinks.sort((a, b) => b.similarity - a.similarity);
          
          connectedLinks.forEach(link => {
            const connectedId = link.source.id === d.id ? link.target.id : link.source.id;
            const connectedNode = data.nodes.find(n => n.id === connectedId);
            const score = Math.round(link.similarity * 100);
            
            // Get color class based on score
            let colorClass;
            if (score >= 70) colorClass = 'bg-success';
            else if (score >= 40) colorClass = 'bg-warning';
            else colorClass = 'bg-info';
            
            const connectionItem = document.createElement('div');
            connectionItem.className = 'node-connection';
            connectionItem.innerHTML = `
              <div class="connection-strength ${colorClass}">${score}%</div>
              <div class="connection-info">${connectedNode.name}</div>
              <a href="/compare-documents/${d.id}/${connectedId}" class="btn btn-sm btn-outline-primary ms-auto" title="Compare documents">
                <i class="bi bi-arrows-angle-expand"></i>
              </a>
            `;
            
            nodeConnectionsList.appendChild(connectionItem);
          });
        }
        
        // Show details panel
        selectedDocumentCard.style.display = 'block';
      }
      
      // Clear node selection
      function clearSelection() {
        selectedNode = null;
        
        // Reset styles
        nodes.selectAll('circle').attr('stroke', '#FFFFFF').attr('stroke-width', 2);
        links.attr('stroke', '#9CA3AF').attr('stroke-opacity', 0.6);
        
        // Hide details panel
        selectedDocumentCard.style.display = 'none';
      }
      
      // Toggle highlight connections
      function toggleHighlightConnections() {
        if (!selectedNode) return;
        
        // Dim all nodes and links first
        nodes.selectAll('circle').attr('stroke', '#FFFFFF').attr('stroke-opacity', 0.3);
        links.attr('stroke', '#CCCCCC').attr('stroke-opacity', 0.2);
        
        // Highlight selected node
        nodes.filter(n => n.id === selectedNode.id)
          .select('circle')
          .attr('stroke', '#FF9E0B')
          .attr('stroke-width', 3)
          .attr('stroke-opacity', 1);
        
        // Find connected links and nodes
        const connectedLinks = data.links.filter(link => 
          link.source.id === selectedNode.id || link.target.id === selectedNode.id);
        
        // Highlight connected links
        links.filter(link => 
          link.source.id === selectedNode.id || link.target.id === selectedNode.id)
          .attr('stroke', link => {
            // Color based on similarity
            if (link.similarity >= 0.7) return '#4CAF50';
            if (link.similarity >= 0.4) return '#FF9E0B';
            return '#03DAC5';
          })
          .attr('stroke-opacity', 0.8)
          .attr('stroke-width', link => 2 + link.similarity * 4);
        
        // Highlight connected nodes
        connectedLinks.forEach(link => {
          const connectedId = link.source.id === selectedNode.id ? link.target.id : link.source.id;
          
          nodes.filter(n => n.id === connectedId)
            .select('circle')
            .attr('stroke', '#FF9E0B')
            .attr('stroke-opacity', 1);
        });
      }
      
      // Focus on a specific node
      function focusNode(node) {
        // Center view on the node with animation
        const scale = 1.5;
        
        svg.transition()
          .duration(500)
          .call(zoom.transform, 
            d3.zoomIdentity
              .translate(width/2, height/2)
              .scale(scale)
              .translate(-node.x, -node.y)
          );
        
        // Update slider
        updateZoomSlider();
        
        // Select the node
        selectNode(node);
      }
      
      // Update zoom slider to match current zoom level
      function updateZoomSlider() {
        if (zoomSlider) {
          zoomSlider.value = currentTransform.k;
        }
      }
      
      // Apply cluster layout
      function applyClusterLayout() {
        // Stop the current simulation
        simulation.stop();
        
        // Group nodes based on connections
        const communities = detectCommunities(data.nodes, data.links);
        
        // Position nodes in clusters
        const clusters = [];
        const numClusters = Math.max(...Object.values(communities)) + 1;
        
        for (let i = 0; i < numClusters; i++) {
          const angle = (2 * Math.PI * i) / numClusters;
          const distance = Math.min(width, height) * 0.4;
          
          clusters.push({
            x: width / 2 + distance * Math.cos(angle),
            y: height / 2 + distance * Math.sin(angle)
          });
        }
        
        // Assign positions to nodes
        data.nodes.forEach(node => {
          const community = communities[node.id] || 0;
          const cluster = clusters[community];
          
          node.x = cluster.x + (Math.random() - 0.5) * 100;
          node.y = cluster.y + (Math.random() - 0.5) * 100;
        });
        
        // Restart simulation with new forces
        simulation
          .force('x', d3.forceX().strength(0.1).x(d => clusters[communities[d.id] || 0].x))
          .force('y', d3.forceY().strength(0.1).y(d => clusters[communities[d.id] || 0].y))
          .alpha(1)
          .restart();
        
        // Update to show new positions
        ticked();
      }
      
      // Simple community detection algorithm
      function detectCommunities(nodes, links) {
        // Create adjacency map
        const adjacency = {};
        
        nodes.forEach(node => {
          adjacency[node.id] = [];
        });
        
        links.forEach(link => {
          const source = typeof link.source === 'object' ? link.source.id : link.source;
          const target = typeof link.target === 'object' ? link.target.id : link.target;
          
          if (!adjacency[source].includes(target)) {
            adjacency[source].push(target);
          }
          
          if (!adjacency[target].includes(source)) {
            adjacency[target].push(source);
          }
        });
        
        // Assign communities
        const communities = {};
        let currentCommunity = 0;
        
        const visited = new Set();
        
        // Do BFS to find connected components
        nodes.forEach(node => {
          if (visited.has(node.id)) return;
          
          // New community
          const queue = [node.id];
          visited.add(node.id);
          communities[node.id] = currentCommunity;
          
          while (queue.length > 0) {
            const current = queue.shift();
            
            adjacency[current].forEach(neighbor => {
              if (!visited.has(neighbor)) {
                visited.add(neighbor);
                communities[neighbor] = currentCommunity;
                queue.push(neighbor);
              }
            });
          }
          
          currentCommunity++;
        });
        
        return communities;
      }
      
      // Apply network settings
      function applyNetworkSettings() {
        // Get settings values
        const minSimilarity = parseFloat(document.getElementById('minSimilaritySlider').value);
        const linkStrength = parseFloat(document.getElementById('linkStrengthSlider').value);
        const nodeSizeOption = document.querySelector('input[name="nodeSizeOption"]:checked').id;
        const layoutType = document.getElementById('layoutSelect').value;
        
        // Update link visibility based on minimum similarity
        links.attr('stroke-opacity', link => link.similarity >= minSimilarity ? 0.6 : 0.1);
        
        // Update link strength
        simulation.force('link').strength(linkStrength);
        
        // Update node size
        if (nodeSizeOption === 'nodeSizeUniform') {
          nodes.selectAll('circle').attr('r', 10);
        } else {
          nodes.selectAll('circle').attr('r', d => 8 + Math.sqrt(d.paragraphs || 5) * 1.2);
        }
        
        // Apply layout
        if (layoutType === 'radial') {
          // Radial layout
          simulation
            .force('x', d3.forceX(width / 2).strength(0.1))
            .force('y', d3.forceY(height / 2).strength(0.1))
            .force('radial', d3.forceRadial(d => 200, width / 2, height / 2).strength(0.3));
        } else if (layoutType === 'cluster') {
          // Apply clustering
          applyClusterLayout();
        } else {
          // Standard force-directed
          simulation
            .force('x', d3.forceX(width / 2).strength(0.1))
            .force('y', d3.forceY(height / 2).strength(0.1));
          
          // Remove radial force if it exists
          simulation.force('radial', null);
        }
        
        // Restart simulation
        simulation.alpha(0.3).restart();
        
        // Hide settings panel
        settingsPanel.classList.add('hidden');
      }
      
      // Export SVG function
      function exportSvg() {
        // Create a copy of the SVG
        const svgCopy = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        const svgContent = document.getElementById('networkSvg').cloneNode(true);
        
        // Set attributes
        svgCopy.setAttribute('width', width);
        svgCopy.setAttribute('height', height);
        svgCopy.setAttribute('viewBox', `0 0 ${width} ${height}`);
        svgCopy.innerHTML = svgContent.innerHTML;
        
        // Convert SVG to string
        const svgString = new XMLSerializer().serializeToString(svgCopy);
        const svgBlob = new Blob([svgString], { type: 'image/svg+xml' });
        const svgUrl = URL.createObjectURL(svgBlob);
        
        // Create download link
        const downloadLink = document.createElement('a');
        downloadLink.href = svgUrl;
        downloadLink.download = 'document-similarity-map.svg';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        URL.revokeObjectURL(svgUrl);
      }
      
      // Add periodic gentle animation
      setInterval(() => {
        simulation.alpha(0.03).restart();
      }, 5000);
    }
  });
</script>
{% endblock %}
